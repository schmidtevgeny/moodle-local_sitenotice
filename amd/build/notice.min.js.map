{"version":3,"file":"notice.min.js","sources":["../src/notice.js"],"sourcesContent":["/**\n * User interaction with notice\n * @author     Nathan Nguyen <nathannguyen@catalyst-au.net>\n * @copyright  Catalyst IT\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    ['jquery', 'core/ajax', 'local_sitenotice/modal_notice'],\n    function($, ajax, ModalNotice) {\n\n        var notices = {};\n        var modal;\n        var viewednotices = [];\n\n        var SiteNotice = {};\n\n        /**\n         * Retrieved notice which has not been viewwed.\n         * @returns {boolean|*}\n         */\n        var getNotice = function() {\n            for (var i in notices) {\n                // Check the notice has been viewed.\n                if (!viewednotices.includes(i)) {\n                    viewednotices.push(i);\n                    return notices[i];\n                }\n            }\n            return false;\n        };\n\n        /**\n         * Show next notice in the modal.\n         */\n        var nextNotice = function() {\n            var nextnotice = getNotice();\n            if (nextnotice == false) {\n                return;\n            }\n            if (typeof modal === 'undefined') {\n                ModalNotice.create({\n                    type: ModalNotice.TYPE,\n                    title: nextnotice.title,\n                    body: nextnotice.content,\n                    large: true,\n                })\n                .then(function (newmodal) {\n                    modal = newmodal;\n\n                    modal.setNoticeId(nextnotice.id);\n                    modal.setRequiredAcknowledgement(nextnotice.reqack);\n\n                    // Event listener for close button.\n                    modal.getModal().on('click', modal.getCloseButtonID(), function() {\n                        dismissNotice();\n                        modal.hide();\n                    });\n                    // Event listener for accept button.\n                    modal.getModal().on('click', modal.getAcceptButtonID(), function() {\n                        acknowledgeNotice();\n                        modal.hide();\n                    });\n                    // Event listener for link tracking.\n                    modal.getModal().on('click', 'a', function() {\n                        var linkid = $(this).attr(\"data-linkid\");\n                        trackLink(linkid);\n                    });\n                    // Event listener for ack checkbox.\n                    modal.getModal().on('click', modal.getAckCheckboxID(), function() {\n                        var ischecked = $(modal.getAckCheckboxID()).is(\":checked\");\n                        $(modal.getAcceptButtonID()).attr('disabled', !ischecked);\n                        if (!ischecked) {\n                            modal.turnonToolTip();\n                        } else {\n                            modal.turnoffToolTip();\n                        }\n                    });\n\n                    modal.show();\n                    modal.getModal().focus();\n                });\n            } else {\n                // Update with new details.\n                modal.setTitle(nextnotice.title);\n                modal.setBody(nextnotice.content);\n                modal.setNoticeId(nextnotice.id);\n                modal.setRequiredAcknowledgement(nextnotice.reqack);\n                modal.show();\n                modal.getModal().focus();\n            }\n        };\n\n        /**\n         * Dismiss Notice.\n         */\n        var dismissNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_dismiss', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Acknowledge notice.\n         */\n        var acknowledgeNotice = function () {\n            var noticeid = modal.getNoticeId();\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_acknowledge', args: { noticeid: noticeid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                } else {\n                    nextNotice();\n                }\n            }).fail(function(ex) {\n                // TODO: Log fail event.\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Link tracking.\n         * @param {Integer} linkid\n         */\n        var trackLink = function (linkid) {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_tracklink', args: {linkid: linkid} }\n            ]);\n\n            promises[0].done(function(response) {\n                if(response.redirecturl) {\n                    window.open(response.redirecturl,\"_parent\", \"\");\n                }\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        /**\n         * Initial Modal with user notices.\n         */\n        SiteNotice.init = function() {\n            var promises = ajax.call([\n                { methodname: 'local_sitenotice_getnotices', args: {} }\n            ]);\n\n            promises[0].done(function(response) {\n                notices = JSON.parse(response.notices);\n                $(document).ready(function() {\n                    nextNotice();\n                });\n            }).fail(function(ex) {\n                this.console.log(ex);\n            });\n        };\n\n        return SiteNotice;\n    }\n);"],"names":["define","$","ajax","ModalNotice","modal","notices","viewednotices","SiteNotice","nextNotice","nextnotice","i","includes","push","getNotice","create","type","TYPE","title","body","content","large","then","newmodal","setNoticeId","id","setRequiredAcknowledgement","reqack","getModal","on","getCloseButtonID","dismissNotice","hide","getAcceptButtonID","acknowledgeNotice","linkid","this","attr","trackLink","getAckCheckboxID","ischecked","is","turnoffToolTip","turnonToolTip","show","focus","setTitle","setBody","noticeid","getNoticeId","call","methodname","args","done","response","redirecturl","window","open","fail","ex","console","log","init","JSON","parse","document","ready"],"mappings":";;;;;;AAOAA,iCACI,CAAC,SAAU,YAAa,kCACxB,SAASC,EAAGC,KAAMC,iBAGVC,MADAC,QAAU,GAEVC,cAAgB,GAEhBC,WAAa,GAoBbC,WAAa,eACTC,WAfQ,eACP,IAAIC,KAAKL,YAELC,cAAcK,SAASD,UACxBJ,cAAcM,KAAKF,GACZL,QAAQK,UAGhB,EAOUG,GACC,GAAdJ,kBAGiB,IAAVL,MACPD,YAAYW,OAAO,CACfC,KAAMZ,YAAYa,KAClBC,MAAOR,WAAWQ,MAClBC,KAAMT,WAAWU,QACjBC,OAAO,IAEVC,MAAK,SAAUC,WACZlB,MAAQkB,UAEFC,YAAYd,WAAWe,IAC7BpB,MAAMqB,2BAA2BhB,WAAWiB,QAG5CtB,MAAMuB,WAAWC,GAAG,QAASxB,MAAMyB,oBAAoB,WACnDC,gBACA1B,MAAM2B,UAGV3B,MAAMuB,WAAWC,GAAG,QAASxB,MAAM4B,qBAAqB,WACpDC,oBACA7B,MAAM2B,UAGV3B,MAAMuB,WAAWC,GAAG,QAAS,KAAK,eAC1BM,OAASjC,EAAEkC,MAAMC,KAAK,eAC1BC,UAAUH,WAGd9B,MAAMuB,WAAWC,GAAG,QAASxB,MAAMkC,oBAAoB,eAC/CC,UAAYtC,EAAEG,MAAMkC,oBAAoBE,GAAG,YAC/CvC,EAAEG,MAAM4B,qBAAqBI,KAAK,YAAaG,WAC1CA,UAGDnC,MAAMqC,iBAFNrC,MAAMsC,mBAMdtC,MAAMuC,OACNvC,MAAMuB,WAAWiB,YAIrBxC,MAAMyC,SAASpC,WAAWQ,OAC1Bb,MAAM0C,QAAQrC,WAAWU,SACzBf,MAAMmB,YAAYd,WAAWe,IAC7BpB,MAAMqB,2BAA2BhB,WAAWiB,QAC5CtB,MAAMuC,OACNvC,MAAMuB,WAAWiB,WAOrBd,cAAgB,eACZiB,SAAW3C,MAAM4C,cACN9C,KAAK+C,KAAK,CACrB,CAAEC,WAAY,2BAA4BC,KAAM,CAAEJ,SAAUA,aAGvD,GAAGK,MAAK,SAASC,UACnBA,SAASC,YACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,IAE5C9C,gBAELiD,MAAK,SAASC,SAERC,QAAQC,IAAIF,QAOrBzB,kBAAoB,eAChBc,SAAW3C,MAAM4C,cACN9C,KAAK+C,KAAK,CACrB,CAAEC,WAAY,+BAAgCC,KAAM,CAAEJ,SAAUA,aAG3D,GAAGK,MAAK,SAASC,UACnBA,SAASC,YACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,IAE5C9C,gBAELiD,MAAK,SAASC,SAERC,QAAQC,IAAIF,QAQrBrB,UAAY,SAAUH,QACPhC,KAAK+C,KAAK,CACrB,CAAEC,WAAY,6BAA8BC,KAAM,CAACjB,OAAQA,WAGtD,GAAGkB,MAAK,SAASC,UACnBA,SAASC,aACRC,OAAOC,KAAKH,SAASC,YAAY,UAAW,OAEjDG,MAAK,SAASC,SACRC,QAAQC,IAAIF,eAOzBnD,WAAWsD,KAAO,WACC3D,KAAK+C,KAAK,CACrB,CAAEC,WAAY,8BAA+BC,KAAM,MAG9C,GAAGC,MAAK,SAASC,UACtBhD,QAAUyD,KAAKC,MAAMV,SAAShD,SAC9BJ,EAAE+D,UAAUC,OAAM,WACdzD,mBAELiD,MAAK,SAASC,SACRC,QAAQC,IAAIF,QAIlBnD"}